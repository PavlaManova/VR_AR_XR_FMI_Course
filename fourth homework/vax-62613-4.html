<!DOCTYPE html>

<html>
	<head>
		<title>Michelin</title>
		<meta charset="utf-8">

		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<script src="three.min.js"></script>
		<script src="vax.js"></script>
	</head>

	<body>
		<script>
			vaxInit();

			// skeleton
	     {
         var pelvis = new THREE.Bone();

			// кости на единия крак
			var legA1 = new THREE.Bone(),
				legB1 = new THREE.Bone(),
				legC1 = new THREE.Bone(),
				legD1 = new THREE.Bone(); // фиктивна кост

			// кости на другия крак
			var legA2 = new THREE.Bone(),
				legB2 = new THREE.Bone(),
				legC2 = new THREE.Bone(),
				legD2 = new THREE.Bone(); // фиктивна кост

				var backA = new THREE.Bone(),
				backB = new THREE.Bone(),
				backC = new THREE.Bone(),
				backD = new THREE.Bone(); // фиктивна кост

			// кости на врата и главата
			var neck = new THREE.Bone(),
				head = new THREE.Bone();

			//кости на едната ръка
			var armA1 = new THREE.Bone();
			var armB1 = new THREE.Bone();
			var armC1 = new THREE.Bone();
			var armD1 = new THREE.Bone();

			//кости на другата ръка
			var armA2 = new THREE.Bone();
			var armB2 = new THREE.Bone();
			var armC2 = new THREE.Bone();
			var armD2 = new THREE.Bone();

			skeleton = new THREE.Skeleton( [pelvis,legA1,legB1,legC1,legD1,legA2,legB2,legC2,legD2] );

			// свързаност на костите
			pelvis.add( legA1, legA2 );

			legA1.add( legB1 );
			legB1.add( legC1 );
			legC1.add( legD1 );

			legA2.add( legB2 );
			legB2.add( legC2 );
			legC2.add( legD2 );

			pelvis.add(backA);
			backA.add(backB);
			backB.add(backC);
			backC.add(backD);

			backD.add(neck);
			neck.add(head);

			neck.add(armA1, armA2);
			armA1.add(armB1);
			armB1.add(armC1);
			armC1.add(armD1);

			armA2.add(armB2);
			armB2.add(armC2);
			armC2.add(armD2);

			// позиция на костите
			pelvis.position.y = 20;

			legA1.position.y = -2;
			legA1.position.z = 5;
			legB1.position.y = 20;
			legC1.position.y = 15;
			legD1.position.y = 5;

			legA2.position.y = -2;
			legA2.position.z = -5;
			legB2.position.y = 20;
			legC2.position.y = 15;
			legD2.position.y = 5;

			legA1.rotation.z = THREE.Math.degToRad( 180 );
			legA2.rotation.z = THREE.Math.degToRad( 180 );

			backA.position.y = 5;
			backB.position.y = 5;
			backC.position.y = 5;
			backD.position.y = 5;

			backA.rotation.z = 0.2;
			backB.rotation.z = -0.1;
			backC.rotation.z = -0.2;
			backD.rotation.z =0.2;

			neck.position.y = 2;
			head.position.y = 4;

			//neck.rotation.z = -0.3;

			armA1.position.y = -1;
			armA1.position.z = 7;
			armB1.position.y = -12;
			armC1.position.y = -9;
			armD1.position.y = -5;

			armA2.position.y = -1;
			armA2.position.z = -7;
			armB2.position.y = -12;
			armC2.position.y = -9;
			armD2.position.y = -5;

			// показване на скелета
			var helper = new THREE.SkeletonHelper( pelvis );
				scene.add( helper, pelvis );
}

      var upperMuscleRight = createUpperThighMuscle(9);
      var upperMuscleLeft = createUpperThighMuscle(-9);

      var middleMuscleRight = createMiddleThighMuscle(10);
      var middleMuscleLeft = createMiddleThighMuscle(-10);

      var lowerMuscleRight = createUpperThighMusce(9);
      var lowerMuscleLeft = createUpperThighMusce(-9);

			function createUpperThighMuscle(translationZ)
      {
        var muscleGeometry = new THREE.SphereGeometry( 6, 40, 40 ).translate(0,12,translationZ);
				skinIndices = [],
				skinWeights = [];

        muscleGeometry.scale(0.7,1,0.6);

			// изчисляване на индексите и теглата на костите за всяка контролна точка
			var pos = muscleGeometry.getAttribute( 'position' );
			for( var i = 0; i<pos.count; i++ )
			{
					skinIndices.push( 3-translationZ*2/9, 0, 0, 0 );
					skinWeights.push( 1, 0, 0, 0 );
			}

			// записване на индексите и теглата като атрибути на геометрията
			muscleGeometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );
			muscleGeometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );

      var elongateGeometry = new THREE.SphereGeometry( 6, 40, 40 ).translate(0,19,translationZ);
      elongateGeometry.scale(0.5,0.7,0.6);

      var ballPositions = [],
        pos = elongateGeometry.getAttribute( 'position' );

      for( var i=0; i<pos.count; i++ )
      {
        ballPositions.push( pos.getX(i), pos.getY(i), pos.getZ(i) );
      }

      // записване на върховете на сфера като морфинг атрибут на позицията
      muscleGeometry.morphAttributes.position = [
				new THREE.Float32BufferAttribute( ballPositions, 3 )
			]

			var upperMuscle = new THREE.SkinnedMesh(
				muscleGeometry,
				new THREE.MeshPhongMaterial({color:'crimson',skinning: true})
			);
			upperMuscle.add( skeleton.bones[0] );
			upperMuscle.bind( skeleton );
			upperMuscle.normalizeSkinWeights( );
			scene.add( upperMuscle );
      return upperMuscle;
    }

      function createMiddleThighMuscle(translationZ)
      {
        var muscleGeometry = new THREE.SphereGeometry( 5, 40, 40 ).translate(0,6,translationZ);
        skinIndices = [],
        skinWeights = [];

        muscleGeometry.scale(0.6,0.7,0.5);

        // изчисляване на индексите и теглата на костите за всяка контролна точка
        var pos = muscleGeometry.getAttribute( 'position' );
        for( var i = 0; i<pos.count; i++ )
        {
          skinIndices.push( 3-translationZ*1/5, 0, 0, 0 );
          skinWeights.push( 1, 0, 0, 0 );
        }

        // записване на индексите и теглата като атрибути на геометрията
        muscleGeometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );
        muscleGeometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );

        var elongateGeometry = new THREE.SphereGeometry( 5, 40, 40 ).translate(0,8,translationZ);
        elongateGeometry.scale(0.7,0.8,0.5);

        var ballPositions = [],
        pos = elongateGeometry.getAttribute( 'position' );

        for( var i=0; i<pos.count; i++ )
        {
          ballPositions.push( pos.getX(i), pos.getY(i), pos.getZ(i) );
        }

        // записване на върховете на сфера като морфинг атрибут на позицията
        muscleGeometry.morphAttributes.position = [
        new THREE.Float32BufferAttribute( ballPositions, 3 )
        ]

        var middleMuscle = new THREE.SkinnedMesh(
        muscleGeometry,
        new THREE.MeshPhongMaterial({color:'crimson',skinning: true})
        );
        middleMuscle.add( skeleton.bones[0] );
        middleMuscle.bind( skeleton );
        middleMuscle.normalizeSkinWeights( );
        scene.add( middleMuscle );
        return middleMuscle;
      }

      function createMiddleThighMuscle(translationZ)
      {
        var muscleGeometry = new THREE.SphereGeometry( 5, 40, 40 ).translate(0,6,translationZ);
        skinIndices = [],
        skinWeights = [];

        muscleGeometry.scale(0.6,0.7,0.5);

        // изчисляване на индексите и теглата на костите за всяка контролна точка
        var pos = muscleGeometry.getAttribute( 'position' );
        for( var i = 0; i<pos.count; i++ )
        {
          skinIndices.push( 3-translationZ*1/5, 0, 0, 0 );
          skinWeights.push( 1, 0, 0, 0 );
        }

        // записване на индексите и теглата като атрибути на геометрията
        muscleGeometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );
        muscleGeometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );

        var elongateGeometry = new THREE.SphereGeometry( 5, 40, 40 ).translate(0,8,translationZ);
        elongateGeometry.scale(0.7,0.8,0.5);

        var ballPositions = [],
        pos = elongateGeometry.getAttribute( 'position' );

        for( var i=0; i<pos.count; i++ )
        {
          ballPositions.push( pos.getX(i), pos.getY(i), pos.getZ(i) );
        }

        // записване на върховете на сфера като морфинг атрибут на позицията
        muscleGeometry.morphAttributes.position = [
        new THREE.Float32BufferAttribute( ballPositions, 3 )
        ]

        var lowerMuscle = new THREE.SkinnedMesh(
        muscleGeometry,
        new THREE.MeshPhongMaterial({color:'crimson',skinning: true})
        );
        lowerMuscle.add( skeleton.bones[0] );
        lowerMuscle.bind( skeleton );
        lowerMuscle.normalizeSkinWeights( );
        scene.add( lowerMuscle );
        return lowerMuscle;
      }


    /*

      var geometry = new THREE.SphereGeometry( 6, 40, 40 ).translate(0,0,4);
				skinIndices = [],
				skinWeights = [];

			// изчисляване на индексите и теглата на костите за всяка контролна точка
			var pos = geometry.getAttribute( 'position' );
			for( var i = 0; i<pos.count; i++ )
			{
					skinIndices.push( 1, 0, 0, 0 );
					skinWeights.push( 1, 0, 0, 0 );
			}

			// записване на индексите и теглата като атрибути на геометрията
			geometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );
			geometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );

			var mesh = new THREE.SkinnedMesh(
				geometry,
				new THREE.MeshPhongMaterial({color:'crimson',skinning: true})
			);
			mesh.add( skeleton.bones[0] );
			mesh.bind( skeleton );
			mesh.normalizeSkinWeights( );
			scene.add( mesh );

			// ляв крак
			var geometry = new THREE.BoxGeometry( 6, 40, 6, 1, 15, 1 ).translate(0,-2,-4);
				skinIndices = [],
				skinWeights = [];

			// изчисляване на индексите и теглата на костите за всяка контролна точка
			var pos = geometry.getAttribute( 'position' );
			for( var i = 0; i<pos.count; i++ )
			{
				var y = pos.getY( i );
				if( y>=-2 )
				{
					var k = THREE.Math.mapLinear( y, -2, 18, 0, 1 );
					skinIndices.push( 0, 5, 6, 1 );
					skinWeights.push( k, 1, 1-k, 0*k );
				}
				else
				if( y>=-18 )
				{
					var k = THREE.Math.mapLinear( y, -18, -2, 0, 1 );
					skinIndices.push( 5, 6, 7, 0 );
					skinWeights.push( k, 1, 1-k, 0 );
				}
				else
				{
					var k = THREE.Math.mapLinear( y, -22, -18, 0, 1 );
					skinIndices.push( 6, 7, 0, 0 );
					skinWeights.push( k, 1, 0, 0 );
				}
			}

			// записване на индексите и теглата като атрибути на геометрията
			geometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );
			geometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );

			var mesh = new THREE.SkinnedMesh(
				geometry,
				new THREE.MeshPhongMaterial({color:'crimson',skinning: true})
			);
			mesh.add( skeleton.bones[0] );
			mesh.bind( skeleton );
			mesh.normalizeSkinWeights( );
			scene.add( mesh );


			// тяло
			var geometry = new THREE.BoxGeometry( 6, 20, 14, 10, 15, 10 ).translate(0,28,0);
				skinIndices = [],
				skinWeights = [];

			// изчисляване на индексите и теглата на костите за всяка контролна точка
			var pos = geometry.getAttribute( 'position' );
			for( var i = 0; i<pos.count; i++ )
			{
				var y = pos.getY( i );
				var x = pos.getZ( i );

				if( y>=28 )
				{
					skinIndices.push( 0, 0, 0, 0 );
					skinWeights.push( 1, 0, 0, 0 );
				}
				else
				{
					var k = THREE.Math.mapLinear( y, 18, 28, 1, 0 );
					skinIndices.push( 0, 1, 5, 0 );
					skinWeights.push( 1, x<0?0:k, x<0?k:0, 0 );
				}

			}

			// записване на индексите и теглата като атрибути на геометрията
			geometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );
			geometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );


			var mesh = new THREE.SkinnedMesh(
				geometry,
				new THREE.MeshPhongMaterial({color:'crimson',skinning: true})
			);
			mesh.add( skeleton.bones[0] );
			mesh.bind( skeleton );
			//mesh.normalizeSkinWeights( );
			scene.add( mesh );*/


			function animate( t )
			{
				var s = Math.sin(4*t);
				var z = -s;

				legA1.rotation.z = THREE.Math.degToRad( 180 - 45*s );
				legB1.rotation.z = THREE.Math.degToRad( -60 - 60*s );
				legC1.rotation.z = THREE.Math.degToRad( 90 );

				legA2.rotation.z = THREE.Math.degToRad( 180 - 45*z );
				legB2.rotation.z = THREE.Math.degToRad( -60 - 60*z );

				armA1.rotation.z = THREE.Math.degToRad( 45*s );
        armB1.rotation.z = THREE.Math.degToRad( 40+40*s );

				armA2.rotation.z = THREE.Math.degToRad( 45*z );
        armB2.rotation.z = THREE.Math.degToRad( 40 + 40*z );

				//mesh.rotation.y = t/2;

        upperMuscleRight.morphTargetInfluences[ 0 ] = THREE.Math.clamp( -s, 0, 1 );
        upperMuscleLeft.morphTargetInfluences[ 0 ] = THREE.Math.clamp( s, 0, 1 );

        middleMuscleRight.morphTargetInfluences[ 0 ] = THREE.Math.clamp( -s, 0, 1 );
        middleMuscleLeft.morphTargetInfluences[ 0 ] = THREE.Math.clamp( s, 0, 1 );
				//helper.visible = (t%6) < 3;
        pelvis.rotation.y=t/2;
			}


		</script>
	</body>
</html>
